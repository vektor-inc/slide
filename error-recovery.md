---
marp: true
---
<!-- 
theme: vk-slide
size: 16:9
paginate: true
style: |
_paginate: false 
-->
<!-- _class: title -->
<!-- Scoped style -->



<!-- _class: title -->
![bg](themes/vk-slide/images/vws_title_01_red.svg)

VWS オンライン勉強会 #033

# WordPressトラブルシューティング

---

### はじめに

今回の内容は、エンジニアではない人がトラブルに遭遇した時にできる対応についての紹介です。
プログラムのデバッグ・修正方法のお話ではありませんので予めご了承願います。

---

### <center>本日の概要

復旧関連

* サイトが表示されなくなった
  - Fatal Error の原因
  - サイトが落ちる主なエラーの種類
* Fatal Error（致命的なエラー）からの復旧
  - リカバリーモードで復旧
  - リカバリーモードが使えない場合
  - バックアップの留意事項

---

復旧しない場合やその他の不具合

* 検証環境の準備
* 不具合原因の特定
* 不具合を引き起こす要因
* その他よくあるトラブル

---

<!-- _class: title-chapter  -->
<!-- _paginate: false  -->
![bg](themes/vk-slide/images/vws_title_01_lightgray.svg)

# サイトが表示されなくなった
#### Fatal Error とは


---

## Fatal Error の原因

* テーマ・プラグインを更新した際に、__利用中のテーマ・プラグインと処理が干渉__ している
* テーマ・プラグインのアップデート時に __アップデートのデータ自体に不具合があった__


<p class="alert alert-warning">自動アップデートが走ってエラーが発生してサイトが落ちてしまう事がある</p>

---

# <center>お詫び</center>

ベクトル製品も過去に数回発生させております。大変申し訳ありません。
順次対策を厚くしておりますので、発生率は確実に下がっているのですが、WordPressの場合はユーザーの利用環境も幅が広く、確認しきれない面もあるため、万が一に備えて覚えておいてください。

---

その他

* 自分でカスタマイズしたPHPにエラーがある
* ダウンロードやアップロード、ファイル展開の過程でファイルが破損した

---

## サイトが落ちる主なエラーの種類

なぜサイトが落ちるのかはエラーメッセージを読めば概ねわかります

* ファイルがない
* クラスの読み込みに失敗している
* 存在しない関数やクラスを使っている

---

### ファイルがない

<div class="alert alert-warning">
failed to open stream: No such file or directory ...
</div>

が含まれていたら、本来必要なファイルが存在しないという状態。

---

### 存在しない関数やクラスを使っている

<div class="alert alert-warning">
Fatal error: Uncaught Error: Call to undefined function ***() in ...
</div>

例えば WordPress 5.9 で追加された新しい関数をプラグインで使っていたりすると、5.9より前のバージョンの WordPress のサイトでは存在しないのでエラーになる。

---

#### 一般的には以下のような対策がしてある

利用時は例えば以下のように該当の関数があるかチェックしてから呼び出したりするが、これを怠った場合に環境によって Fatal error になってしまう

```
if ( function_exists( 'wp_body_open' ) ) {
	wp_body_open();
} else {
	do_action( 'wp_body_open' );
}
```

---

### PHPのクラスの読み込みに失敗している

<div class="alert alert-warning">
Fatal error: Uncaught Error: Class '***' not found in ...
</div>

定義されていないPHPのクラス（処理）が使われているという事で、概ね該当のクラスの定義（読み込み）に失敗している状態。

定義しているけれど、定義を読み込む前に使用されてるとか。

※ 通常はそういう事が発生しないように autoloader と呼ばれるものを使うのですが、その設定のアップデートミスなどもありえる

---

### 同じ関数名を２重に宣言されている

<div class="alert alert-warning">
Fatal error: Cannot redeclare ***() (previously declared in ... 
</div>

既に存在している関数名を更に宣言したという状態です。

プラグインA : function my_get_title(){ }
プラグインB : function my_get_title(){ }

テーマやプラグインのアップデートで落ちるケースとしては、
先に紹介したものに比べればほぼ皆無です。

---

#### 余談

こういったエラーを引き起こさないように、テーマやプラグインでは個別の接頭辞をつけるルールになっています。

例えば カスタムフィールドの値を取得する関数を作るとして、get_field_data() という名前にしようとすると、他の開発者も同じ事を考えて同じ関数名をつけるとエラーになってしまいます。

これをさけるために例えば lightning なら lightning_get_field_data() にするというようなルールです。

受託案件の開発で何か関数を作る時も、関数名が重複してエラーにならないように接頭辞をつけましょう。


---


<!-- _class: title-chapter  -->
<!-- _paginate: false  -->
![bg](themes/vk-slide/images/vws_title_01_lightgray.svg)

# Fatal Error からの復旧作業


---

## リカバリーモード

* WordPress 5.2 から実装された
* サイトで致命的なエラーが発生した場合は通知メールが届く
→ __サイトが落ちた事がわかる__
* 通知メールには、リカバリーモードで管理画面にアクセスできるようにするリンクURLが記載してある
→ __サーバーに繋げなくても、管理画面から復旧作業ができる__

---

## リカバリーメールが届くか確認しておく

### 登録メールアドレスの再確認

管理メールアドレスにメールが届く
→ 管理メールアドレスは必ずちゃんと届くメールアドレスに！

---

### 実際にリカバリーメールを受信してみる

まずはエラーが発生した場合にリカバリーメールが届くか確認しておきましょう。

#### 例A : 子テーマの functions.php を改変

---

#### 例B : エラーの発生するプラグインのアップロード

1. 利用しているプラグインをダウンロード
2. わざとエラーが出るように変更
3. サーバーにアップロード（zipに圧縮して管理画面からアップロードでも可）

これでエラーが発生するはず

---

## リカバリーメールがちゃんと届くか確認
* 届いていない場合は迷惑フォルダーに振り分けられないか確認

---

### 問題のある箇所の特定

* サイト上にエラーの箇所が記載されている
* リカバリーメールに該当エラーの箇所が記載されている

→ 原因となるテーマあるいはプラグインの特定が可能

---

### リカバリーモードで復旧

* メールに添付のURLをクリックしてリカバリーモードでログイン
* 問題となっているテーマ・プラグインを管理画面から一旦削除
* 再度最新版をインストール
* 正常に表示されたら __リカバリーモードを終了__

---

### メールが届かなくてリカバリーモードで管理画面に入れない場合（SFTPなどで復旧）

* とりあえずサイトに表示されているエラーメッセージの中で、原因と思われるテーマ・プラグインを確認
* SFTPソフトなどでサーバーに直接接続して該当のプラグインまたはディレクトリを削除
* 問題と思われるテーマ・プラグインの最新版をSFTPなどで手動でアップしてインストール

---

### 最新版再インストールでも復旧しない場合

* バックアップがあればバックアップから復元
* 該当テーマ・プラグインの開発元で不具合情報がアナウンスされているか確認
* 該当プラグイン名で twitter / Google で検索してみる

→ とにかく自動定期バックアップはとるようにしてください。

---

WordPressでFatal errorが表示した時の復旧方法
https://www.vektor-inc.co.jp/post/resolve-fatal-errors/

「 サイトで技術的な問題が発生しています 」が表示されたらリカバリーモードを試してみよう
https://www.vektor-inc.co.jp/post/wordpress-recovery-mode/


---

# バックアップについて補足

---

## バックアップは二重にかけよう

同一サーバー内だけだとサーバー障害でバックアップごと全滅する事もある

* 同一サーバー内（毎日）
* 外部サーバーに自動転送
* 定期的に手動でローカルにダウンロード

https://www.vektor-inc.co.jp/post/updraftplus-aws-s3/

---

## サーバーバックアップとの違い

レンタルサーバーでバックアップのサービスを提供してくれるところもある

借りている領域全体をバックアップする方式の場合、
同じサーバー内に複数のWordPressが入れていると、
全サイト一括復元になったりるので注意

---

<!-- _class: title-chapter  -->
<!-- _paginate: false  -->
![bg](themes/vk-slide/images/vws_title_01_lightgray.svg)

# 復旧しない場合や<br>その他の不具合

---

## 検証環境を用意しよう

まずは気兼ねなく検証作業をするために検証環境を用意しましょう。

1. Local by Flywheel などで検証環境を用意
1. 本番サイトのデータをプラグイン「All in One WP Migration」などでエクスポート
3. 検証環境にインポートして再現

https://training.vektor-inc.co.jp/courses/how-to-run-wordpress-site/

---

ちなみに無料版の All in One WP Migration ではサイトのデータ容量が 300M までしかデータのインポートができません。手動で頑張る方法はありますが、有料版を買った方が圧倒的に楽なので有料版を買いましょう。


---

### 余談 : 復元に失敗したら <br>UpdraftPlus で復元するのもあり

* UpdraftPlus のバックアップデータをダウンロード
* 開発環境に UpdraftPlus をインストール
* 開発環境の /wp-content/updraft/ ディレクトリにバックアップデータを入れる
* UpdraftPlus で バックアップデータからの復元を実行
* データベース内のURLを置換（詳細は次項）

---

#### URLの置換

無料版の UpdraftPlus はインポートしただけだと、環境に応じてURLの置換などは行わないので、サイトを見ると本番サイトにリダイレクトされてしまいます。

local by flywheel の場合、Open Site Shell から

```
wp search-replace 本番のURL 開発環境のURL
```

を叩けばURLが置換され、開発環境でももそのまま表示されるようになる。

---

## 検証環境では問題が発生しない場合

サーバー環境に問題がある可能性が高い

* PHPのバージョンが古い
* WAFが干渉している
* サーバーキャッシュの問題

---

# 不具合原因の特定
まずは基本的な事を再確認

---

## テーマ・プラグインは最新版に

言うまでもなくまずは最新版にしてください。
不具合があっても既に修正した最新版がリリースされている可能性が高いので、まずは最新版にしましょう。

---

## PHPのバージョンが古すぎないか？

PHPのバージョンが古いと、正常に動作しないものが数多くあります。

PHP 5.6 は論外。 7.2 も誤動作するプラグインがありますので、まずは PHP のバージョンは 7.4 以降にしましょう。

---

## コンソールエラーが出ていないか？

ブラウザの開発ツールの console でエラーが出ていないか確認

赤くなっているエラーメッセージがあれば、そこに原因があったりする。

* JavaScript のプログラムエラー
* 画像 / CSS / JavaScript などファイルが存在しない

---

## テーマなのかプラグインなのか？

* プラグインを停止して改善するか？
* 子テーマでカスタマイズしている場合は親テーマに変更して改善するか？
* プラグインは組み合わせで不具合が発生したりするので、ちゃんと全部停止してから一つずつ有効化したりして確認する

---

フォーラムで
__「親テーマへの変更やプラグインを停止して改善されるか確認しましたか？」で「はい」と答えてる質問でも、結局上記が原因の場合が非常に多い。__

---

## ブラウザのシークレットモードや別のブラウザ、別の端末で再現するか？

表示崩れなどの場合は、どの環境でも発生するのか、特定の端末だけで発生するのか確認

他のプラグインを停止しても発生するならテーマやプラグインの原因の可能性が高い
→ フォーラムなどで報告

---

## デバッグモードは on にする

wp-config.php に 

```
define( 'WP_DEBUG', true );
```
を書き足すとPHPのエラーがある場合にはエラーメッセージが表示される

---


<!-- _class: title-chapter  -->
<!-- _paginate: false  -->
![bg](themes/vk-slide/images/vws_title_01_lightgray.svg)

# 不具合を引き起こす要因

---

## 高速化系の処理をするプラグイン

高速化するために CSS/JavaScript のファイルのコードを加工したり読み込み順を変更

* CSSの読み込み優先順位などが変更され、本来のデザイン指定が効かなくなったりする
* JavaScript のプログラムが正常に動作しなくなり、スライドショーやアニメーションなどの動作がおかしくなる

とりあえず停止して改善するか確認

---

## http と https が混在している

<p class="alert alert-warning">最初 http のアドレスでページを作成して、途中から URL を https に変更した</p>

現在のブラウザのほとんどは、サイトのURLが https の場合、http の画像を表示しないので、画像が表示されなくなったりする。

このあたりも開発ツールの console を見ればエラーメッセージが表示されているはず

---

### 対応

* 画像の再配置・保存
→ httpsのURLでデータベースに保存される）
* プラグイン「Really Simple SSL」などで対応

__画像のURLが https で始まる URL になるようにする__

---

## 不適切なスラッグ・URL指定をしている

カスタム投稿タイプのスラッグ名と、固定ページのパーマリンクのスラッグ名が同じなど、ページとしては違うはずなのに同じURLになるようなスラッグの指定をしている

→ ユーザーは固定ページが表示されると思っていたが、WordPress は該当スラッグの投稿タイプのアーカイブページを表示する

---

### 対応

* 設定 > パーマリンク設定 をデフォルトにして改善するか確認
* 問題のあるスラッグ名を変更

---

<!-- _class: title-chapter  -->
<!-- _paginate: false  -->
![bg](themes/vk-slide/images/vws_title_01_lightgray.svg)

# おまけ : その他のトラブル

---

## ハッキングされた

ハッキングされた場合の対応は...またボリュームが多いので、下記参照ください。

WordPressが改竄された時の復旧方法と絶対に改竄されない対策
https://www.vektor-inc.co.jp/post/wordpress-hacked-2021/

---

## ログイン情報がわからない

前の担当者・開発者が音信不通で管理画面にログインできない

#### プログラムで管理権限を持つユーザーを発行

管理ユーザーのログイン情報が不明でログインできない場合の対処法
https://training.vektor-inc.co.jp/courses/how-to-run-wordpress-site/lessons/wp-insert-user-php-and-login/

---

## クライアントが<br>「何もしてないのに壊れた」と言い張る

ユーザーがどんな操作をしたのか履歴を取るプラグインを入れておきましょう。

https://ja.wordpress.org/plugins/stream/

---

## 未経験からキラキラWEBデザイナーになれる！と謳うスクールに入ったけど仕事が取れない。

スクールの集まりじゃなくて、WordPressミートアップみたいに、現役のウェブ制作者があつまる集まる勉強会に参加したりして話を聞いた方が...

---

<!-- _class: title -->
<!-- _paginate: false  -->
![bg](themes/vk-slide/images/vws_title_01_red.svg)

# ありがとうございました
